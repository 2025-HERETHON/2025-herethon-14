<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>경찰서 & 법무법인 지도</title>
  <style>
    #map, #lawMap {
      width: 100%;
      height: 400px;
      margin-bottom: 20px;
    }
    .list-toggle {
      margin-bottom: 10px;
      cursor: pointer;
      color: blue;
      text-decoration: underline;
    }
  </style>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=99fb650695dceb9f3c38f165656fe2c8"></script>
</head>
<body>
    <nav>
        <a href="{% url 'main:main' %}">홈</a>
        <a href="{% url 'main:about' %}">폭력이란?</a>
        <a href="{% url 'institutions:index' %}">관련 기관</a>
        <a href="{% url 'timelog:index' %}">내 저장소</a>
        <a href="{% url 'exitlog:index' %}">탈출기</a>
        <a href="#">프로파일링</a>
    </nav> 

  <h2>🟦 경찰서 위치</h2>
  <div class="list-toggle" onclick="toggleList('policeList')">[경찰서 리스트 토글]</div>
  <ul id="policeList" style="display: none;"></ul>
  <div id="map"></div>

  <h2>🔴 법무법인 위치</h2>
  <div class="list-toggle" onclick="toggleList('lawList')">[법무법인 리스트 토글]</div>
  <ul id="lawList" style="display: none;"></ul>
  <div id="lawMap"></div>

  <script>
    let policeMap, lawMap;

    function toggleList(id) {
      const list = document.getElementById(id);
      list.style.display = list.style.display === "none" ? "block" : "none";
    }

    function createMap(containerId, center) {
      return new kakao.maps.Map(document.getElementById(containerId), {
        center: new kakao.maps.LatLng(center.lat, center.lng),
        level: 12
      });
    }

    function addMarker(map, lat, lng, title, color) {
      let imageUrl = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png"; // 기본 빨강
      if (color === "blue") {
        imageUrl = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_blue.png";
      }

      const markerImage = new kakao.maps.MarkerImage(
        imageUrl,
        new kakao.maps.Size(24, 35),
        { offset: new kakao.maps.Point(12, 35) }
      );

      const marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(lat, lng),
        title: title,
        image: markerImage
      });

      marker.setMap(map);
    }

    function fetchPolice() {
      fetch('/institutions/api/policeoffice/list/')
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById("policeList");
          if (data.length > 0) {
            policeMap = createMap("map", {
              lat: parseFloat(data[0].위도),
              lng: parseFloat(data[0].경도)
            });
          }

          data.forEach(p => {
            if (p.위도 && p.경도) {
              const lat = parseFloat(p.위도);
              const lng = parseFloat(p.경도);
              addMarker(policeMap, lat, lng, p.관명, "blue");

              const li = document.createElement("li");
              li.innerText = `${p.관명} (${p.주소})`;
              list.appendChild(li);
            }
          });
        });
    }

    function fetchLawfirms() {
      fetch('/institutions/api/lawfirms/list/')
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById("lawList");
          if (data.length > 0) {
            lawMap = createMap("lawMap", {
              lat: parseFloat(data[0].위도),
              lng: parseFloat(data[0].경도)
            });
          }

          data.forEach(p => {
            if (p.위도 && p.경도) {
              const lat = parseFloat(p.위도);
              const lng = parseFloat(p.경도);
              addMarker(lawMap, lat, lng, p.법무법인명, "red");

              const li = document.createElement("li");
              li.innerText = `${p.법무법인명} (${p.주소})`;
              list.appendChild(li);
            }
          });
        });
    }

    window.onload = function() {
      fetchPolice();
      fetchLawfirms();
    }
  </script>
</body>
</html>
