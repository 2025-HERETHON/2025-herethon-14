<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ê²½ì°°ì„œ & ë²•ë¬´ë²•ì¸ ì§€ë„</title>
  <style>
    #map, #lawMap {
      width: 100%;
      height: 400px;
      margin-bottom: 20px;
    }
    .list-toggle {
      margin-bottom: 10px;
      cursor: pointer;
      color: blue;
      text-decoration: underline;
    }
  </style>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=99fb650695dceb9f3c38f165656fe2c8"></script>
</head>
<body>
    <nav>
        <a href="{% url 'main:main' %}">í™ˆ</a>
        <a href="{% url 'main:about' %}">í­ë ¥ì´ë€?</a>
        <a href="{% url 'institutions:index' %}">ê´€ë ¨ ê¸°ê´€</a>
        <a href="{% url 'timelog:index' %}">ë‚´ ì €ì¥ì†Œ</a>
        <a href="{% url 'exitlog:index' %}">íƒˆì¶œê¸°</a>
        <a href="#">í”„ë¡œíŒŒì¼ë§</a>
    </nav> 

  <h2>ğŸŸ¦ ê²½ì°°ì„œ ìœ„ì¹˜</h2>
  <div class="list-toggle" onclick="toggleList('policeList')">[ê²½ì°°ì„œ ë¦¬ìŠ¤íŠ¸ í† ê¸€]</div>
  <ul id="policeList" style="display: none;"></ul>
  <div id="map"></div>

  <h2>ğŸ”´ ë²•ë¬´ë²•ì¸ ìœ„ì¹˜</h2>
  <div class="list-toggle" onclick="toggleList('lawList')">[ë²•ë¬´ë²•ì¸ ë¦¬ìŠ¤íŠ¸ í† ê¸€]</div>
  <ul id="lawList" style="display: none;"></ul>
  <div id="lawMap"></div>

  <script>
    let policeMap, lawMap;

    function toggleList(id) {
      const list = document.getElementById(id);
      list.style.display = list.style.display === "none" ? "block" : "none";
    }

    function createMap(containerId, center) {
      return new kakao.maps.Map(document.getElementById(containerId), {
        center: new kakao.maps.LatLng(center.lat, center.lng),
        level: 12
      });
    }

    function addMarker(map, lat, lng, title, color) {
      let imageUrl = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png"; // ê¸°ë³¸ ë¹¨ê°•
      if (color === "blue") {
        imageUrl = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_blue.png";
      }

      const markerImage = new kakao.maps.MarkerImage(
        imageUrl,
        new kakao.maps.Size(24, 35),
        { offset: new kakao.maps.Point(12, 35) }
      );

      const marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(lat, lng),
        title: title,
        image: markerImage
      });

      marker.setMap(map);
    }

    function fetchPolice() {
      fetch('/institutions/api/policeoffice/list/')
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById("policeList");
          if (data.length > 0) {
            policeMap = createMap("map", {
              lat: parseFloat(data[0].ìœ„ë„),
              lng: parseFloat(data[0].ê²½ë„)
            });
          }

          data.forEach(p => {
            if (p.ìœ„ë„ && p.ê²½ë„) {
              const lat = parseFloat(p.ìœ„ë„);
              const lng = parseFloat(p.ê²½ë„);
              addMarker(policeMap, lat, lng, p.ê´€ëª…, "blue");

              const li = document.createElement("li");
              li.innerText = `${p.ê´€ëª…} (${p.ì£¼ì†Œ})`;
              list.appendChild(li);
            }
          });
        });
    }

    function fetchLawfirms() {
      fetch('/institutions/api/lawfirms/list/')
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById("lawList");
          if (data.length > 0) {
            lawMap = createMap("lawMap", {
              lat: parseFloat(data[0].ìœ„ë„),
              lng: parseFloat(data[0].ê²½ë„)
            });
          }

          data.forEach(p => {
            if (p.ìœ„ë„ && p.ê²½ë„) {
              const lat = parseFloat(p.ìœ„ë„);
              const lng = parseFloat(p.ê²½ë„);
              addMarker(lawMap, lat, lng, p.ë²•ë¬´ë²•ì¸ëª…, "red");

              const li = document.createElement("li");
              li.innerText = `${p.ë²•ë¬´ë²•ì¸ëª…} (${p.ì£¼ì†Œ})`;
              list.appendChild(li);
            }
          });
        });
    }

    window.onload = function() {
      fetchPolice();
      fetchLawfirms();
    }
  </script>
</body>
</html>
